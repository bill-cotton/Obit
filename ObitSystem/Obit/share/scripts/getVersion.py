# This script makes the svn revision available to Obit.
#
# A call is made to svnversion to obtain the svn revision in directory $OBIT.
# (Environment variable $OBIT must be defined.)  The value returned by
# svnversion is written to ObitVersion.c, unless ObitVersion.c already contains
# the up-to-date version.
#
# After updating ObitVersion.c, it must be compiled, the Obit library rebuilt, 
# and the python code rebuilt to link the new library to the SWIG C-Python
# interface.
#

from os import environ, popen
import re
from sys import exit
import sys

OBIT = '' # path to Obit directory
filename = '' # C file that will hold version
ver = '' # Obit version string

try:
    # Get svn revision from the OBIT directory, Obit from environment or command line
    if 'OBIT' in environ:
        OBIT = environ['OBIT']
    else:
        OBIT = sys.argv[1]
    filename = OBIT + '/src/ObitVersion.c'
    cmd = 'svnversion -n ' + OBIT
    f = popen(cmd)
    ver = f.read()

    # Get the svn revision written previously to ObitVersion.c
    f = open( filename, 'r' )
    txt = f.read()

    # Compare the current and previous version strings
    matchstr = re.compile('"(.*)"') # get first text in quotes
    groups = re.findall( matchstr, txt )

except KeyError:
    print 'Warning: Obit version not set. Environment variable OBIT not found.'
    ver = 'unavailable'
except IOError:
    # If ver not yet set, raise an exception.  Otherwise, continue
    if ver == '':  
        raise
except Exception:
    print 'Error while getting Obit version.'
    raise
# Need to update?
if ( groups and groups[0] == ver ):
    print "Obit version in ObitVersion.c is already up to date."
    exit() # terminate script
    
# Write version.c to hold and return version information
f = open( filename, 'w' )
txt = """
// This file generated by getVersion.py
// Obit version (svn revision) at build time

#include <ObitVersion.h>

const char *const version = \"""" + ver + """\";

char *ObitVersion (void)
{
    char *ver;
    ver = strdup( version );
    return ver;
}
"""
f.write(txt)
f.close()
print 'Obit version written to ' + filename
